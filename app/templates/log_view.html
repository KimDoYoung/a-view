<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - A-View</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
        }
        
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .content-section {
            padding: 30px 0;
            min-height: calc(100vh - 120px);
        }
        
        .page-title {
            color: #343a40;
            font-weight: 600;
            margin-bottom: 2rem;
        }
        
        .log-container {
            background: #2d3748;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
        }
        
        .log-line {
            color: #e2e8f0;
            margin-bottom: 2px;
            word-wrap: break-word;
        }
        
        .log-line.error {
            color: #fc8181;
        }
        
        .log-line.warning {
            color: #f6e05e;
        }
        
        .log-line.info {
            color: #90cdf4;
        }
        
        .log-line.debug {
            color: #a0aec0;
        }
        
        .controls-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .log-stats {
            background: white;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .search-highlight {
            background-color: #ffd700;
            color: #000;
            padding: 1px 2px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    {% include 'common/nav.html' %}

    <!-- Main Content -->
    <div class="content-section" x-data="logData">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    
                    <!-- 로그 통계 -->
                    <div class="log-stats">
                        <div class="row">
                            <div class="col-md-3">
                                <small class="text-muted">총 라인 수:</small>
                                <strong x-text="originalLogs.length">0</strong>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">파일 경로:</small>
                                <small class="font-monospace">{{ log_file_path }}</small>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">표시 라인:</small>
                                <strong x-text="displayLines">{{ requested_lines }}</strong>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">마지막 업데이트:</small>
                                <small id="lastUpdated"></small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 컨트롤 섹션 -->
                    <div class="controls-section">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" 
                                           class="form-control" 
                                           placeholder="로그 검색..." 
                                           x-model="searchTerm"
                                           @input="filterLogs">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" x-model="filterLevel" @change="filterLogs">
                                    <option value="">모든 레벨</option>
                                    <option value="ERROR">ERROR</option>
                                    <option value="WARNING">WARNING</option>
                                    <option value="INFO">INFO</option>
                                    <option value="DEBUG">DEBUG</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" x-model="displayLines" @change="changeDisplayLines">
                                    <option value="100">100줄</option>
                                    <option value="500">500줄</option>
                                    <option value="1000">1000줄</option>
                                    <option value="2000">2000줄</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <div class="btn-group w-100">
                                    <button class="btn btn-outline-primary btn-sm" @click="refreshLogs">
                                        <i class="fas fa-sync-alt me-1"></i>새로고침
                                    </button>
                                    <a href="/aview/log-download" class="btn btn-outline-success btn-sm">
                                        <i class="fas fa-download me-1"></i>다운로드
                                    </a>
                                    <button class="btn btn-outline-secondary btn-sm" @click="scrollToBottom">
                                        <i class="fas fa-arrow-down me-1"></i>하단
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 로그 내용 -->
                    <div class="log-container" id="logContainer">
                        <!-- 로딩 상태 -->
                        <div x-show="loading" class="text-center text-muted py-4">
                            <i class="fas fa-spinner fa-spin me-2"></i>
                            로그를 불러오는 중...
                        </div>
                        
                        <!-- 검색 결과 없음 -->
                        <div x-show="!loading && filteredLogs.length === 0 && (searchTerm || filterLevel)" class="text-center text-muted py-4">
                            <i class="fas fa-search me-2"></i>
                            검색 결과가 없습니다.
                        </div>
                        
                        <!-- 로그 없음 -->
                        <div x-show="!loading && filteredLogs.length === 0 && !searchTerm && !filterLevel" class="text-center text-muted py-4">
                            <i class="fas fa-file-alt me-2"></i>
                            로그가 없습니다.
                        </div>
                        
                        <!-- 로그 내용 -->
                        <template x-show="!loading" x-for="(line, index) in filteredLogs" :key="index">
                            <div class="log-line" 
                                 :class="getLogLevel(line)"
                                 x-html="highlightSearch(line)">
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function logComponent() {
            return {
                searchTerm: '',
                filterLevel: '',
                displayLines: '1000',
                originalLogs: [],
                filteredLogs: [],
                loading: true,
                
                init() {
                    // AJAX로 로그 데이터 로드
                    this.loadLogData();
                    
                    // 마지막 업데이트 시간 표시
                    document.getElementById('lastUpdated').textContent = new Date().toLocaleString('ko-KR');
                },
                
                async loadLogData() {
                    try {
                        this.loading = true;
                        const response = await fetch(`/aview/log-data?lines=${this.displayLines}`);
                        if (response.ok) {
                            const data = await response.json();
                            this.originalLogs = data.content.split('\n').filter(line => line.trim());
                            this.filteredLogs = [...this.originalLogs];
                            
                            // 페이지 로드 시 맨 아래로 스크롤
                            this.$nextTick(() => {
                                this.scrollToBottom();
                            });
                        } else {
                            console.error('로그 데이터 로드 실패:', response.status);
                        }
                    } catch (error) {
                        console.error('로그 데이터 로드 에러:', error);
                    } finally {
                        this.loading = false;
                    }
                },
                
                filterLogs() {
                    let logs = [...this.originalLogs];
                    
                    // 검색어 필터
                    if (this.searchTerm) {
                        logs = logs.filter(line => 
                            line.toLowerCase().includes(this.searchTerm.toLowerCase())
                        );
                    }
                    
                    // 레벨 필터
                    if (this.filterLevel) {
                        logs = logs.filter(line => 
                            line.includes(this.filterLevel)
                        );
                    }
                    
                    this.filteredLogs = logs;
                },
                
                getLogLevel(line) {
                    if (line.includes('ERROR')) return 'error';
                    if (line.includes('WARNING')) return 'warning';
                    if (line.includes('INFO')) return 'info';
                    if (line.includes('DEBUG')) return 'debug';
                    return '';
                },
                
                highlightSearch(line) {
                    if (!this.searchTerm) return line;
                    
                    const regex = new RegExp(`(${this.searchTerm})`, 'gi');
                    return line.replace(regex, '<span class="search-highlight">$1</span>');
                },
                
                scrollToBottom() {
                    const container = document.getElementById('logContainer');
                    container.scrollTop = container.scrollHeight;
                },
                
                changeDisplayLines() {
                    this.loadLogData();
                },
                
                refreshLogs() {
                    this.loadLogData();
                    document.getElementById('lastUpdated').textContent = new Date().toLocaleString('ko-KR');
                }
            }
        }
        // Alpine.js 초기화
        document.addEventListener('alpine:init', () => {
            Alpine.data('logData', logComponent);
        });        
    </script>
</body>
</html>