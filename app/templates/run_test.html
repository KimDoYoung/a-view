<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - A-View</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/image/favicon16.png">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
        }
        
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .content-section {
            padding: 30px 0;
            min-height: calc(100vh - 120px);
        }
        
        .page-title {
            color: #343a40;
            font-weight: 600;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    {% include 'common/nav.html' %}

    <!-- Main Content -->
    <div class="content-section" x-data="testData">
        <div class="container-fluid py-4">
            
            <div class="row">
                <!-- 파일 관리 영역 (4/12) -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">파일 목록</h5>
                        </div>
                        <div class="card-body">
                            <!-- 파일 목록 -->
                            <div class="file-list mb-3">
                                <div class="list-group list-group-flush">
                                    <template x-for="(file, index) in files" :key="index">
                                        <div class="list-group-item">
                                            <div class="form-check">
                                                <input 
                                                    class="form-check-input" 
                                                    type="checkbox" 
                                                    :id="'file-' + index"
                                                    x-model="file.checked"
                                                    @change="updateSelectedFiles()"
                                                >
                                                <label 
                                                    class="form-check-label w-100" 
                                                    :for="'file-' + index"
                                                    :title="file.name"
                                                >
                                                    <div class="d-flex justify-content-between align-items-center w-100">
                                                        <span x-text="file.name" class="text-truncate flex-grow-1 me-2"></span>
                                                        <small class="text-muted text-nowrap" x-show="file.size > 0" x-text="formatFileSize(file.size)">
                                                        </small>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </template>
                                    <div x-show="files.length === 0" class="list-group-item text-muted text-center">
                                        업로드된 파일이 없습니다.
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 파일 관리 버튼 -->
                            <div class="row g-2">
                                <input type="file" class="d-none" id="fileUpload" multiple @change="uploadFiles($event)">
                                <div class="col-4">
                                    <button class="btn btn-primary w-100 btn-sm" onclick="document.getElementById('fileUpload').click()">
                                        <i class="bi bi-upload me-1"></i>
                                        업로드
                                    </button>
                                </div>
                                <div class="col-4">
                                    <button 
                                        class="btn btn-warning w-100 btn-sm" 
                                        :disabled="!hasCheckedFiles"
                                        @click="deleteSelected()"
                                    >
                                        <i class="bi bi-trash me-1"></i>
                                        선택삭제
                                    </button>
                                </div>
                                <div class="col-4">
                                    <button 
                                        class="btn btn-danger w-100 btn-sm" 
                                        :disabled="files.length === 0"
                                        @click="deleteAll()"
                                    >
                                        <i class="bi bi-trash3 me-1"></i>
                                        모두삭제
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 실행 설정 영역 (8/12) -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">실행 설정</h5>
                        </div>
                        <div class="card-body">
                            <!-- Convert/View 선택 -->
                            <div class="mb-3">
                                <label class="form-label">동작 모드</label>
                                <div class="d-flex gap-3">
                                    <div class="form-check">
                                        <input 
                                            class="form-check-input" 
                                            type="radio" 
                                            id="modeConvert" 
                                            value="convert"
                                            x-model="mode"
                                            @change="updateUrl()"
                                        >
                                        <label class="form-check-label" for="modeConvert">Convert</label>
                                    </div>
                                    <div class="form-check">
                                        <input 
                                            class="form-check-input" 
                                            type="radio" 
                                            id="modeView" 
                                            value="view"
                                            x-model="mode"
                                            @change="updateUrl()"
                                        >
                                        <label class="form-check-label" for="modeView">View</label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Path/URL 선택 -->
                            <div class="mb-3">
                                <label class="form-label">입력 방식</label>
                                <div class="d-flex gap-3">
                                    <div class="form-check">
                                        <input 
                                            class="form-check-input" 
                                            type="radio" 
                                            id="inputPath" 
                                            value="path"
                                            x-model="inputType"
                                            @change="updateUrl()"
                                        >
                                        <label class="form-check-label" for="inputPath">Path</label>
                                    </div>
                                    <div class="form-check">
                                        <input 
                                            class="form-check-input" 
                                            type="radio" 
                                            id="inputUrl" 
                                            value="url"
                                            x-model="inputType"
                                            @change="updateUrl()"
                                        >
                                        <label class="form-check-label" for="inputUrl">URL</label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 출력 형식 선택 -->
                            <div class="mb-3">
                                <label class="form-label">출력 형식</label>
                                <div class="d-flex gap-3">
                                    <div class="form-check">
                                        <input 
                                            class="form-check-input" 
                                            type="radio" 
                                            id="outputPdf" 
                                            value="pdf"
                                            x-model="output"
                                            @change="updateUrl()"
                                        >
                                        <label class="form-check-label" for="outputPdf">PDF</label>
                                    </div>
                                    <div class="form-check">
                                        <input 
                                            class="form-check-input" 
                                            type="radio" 
                                            id="outputHtml" 
                                            value="html"
                                            x-model="output"
                                            @change="updateUrl()"
                                        >
                                        <label class="form-check-label" for="outputHtml">HTML</label>
                                    </div>
                                </div>
                                <small class="text-muted" x-show="isOfficeDocument">
                                    Office 문서는 출력 형식을 선택할 수 없습니다.
                                </small>
                            </div>
                            
                            <!-- URL 입력박스 -->
                            <div class="mb-3">
                                <label for="urlInput" class="form-label">실행 URL</label>
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    id="urlInput"
                                    x-model="generatedUrl"
                                >
                            </div>
                            
                            <!-- 실행 버튼 -->
                            <div class="d-grid">
                                <button 
                                    class="btn btn-success btn-lg" 
                                    :disabled="!canRun"
                                    @click="runConversion()"
                                >
                                    실행
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

<!-- 설정 데이터 -->
<script id="app-settings" type="application/json">{{ settings_json|tojson }}</script>

<script>
// 설정 데이터 로드
const appSettings = JSON.parse(document.getElementById('app-settings').textContent);

function testComponent() {
    return {

        files: [],
        mode: 'convert',
        inputType: 'path',
        output: 'pdf',
        generatedUrl: '',
        selectedFile: null,
        
        init() {
            this.loadFiles();
            this.updateUrl();
        },
        
        get hasCheckedFiles() {
            return this.files.some(file => file.checked);
        },
        
        get canRun() {
            return this.selectedFile && this.generatedUrl;
        },
        
        get isOfficeDocument() {
            if (!this.selectedFile) return false;
            const officeExts = ['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'odt', 'ods', 'odp'];
            const ext = this.selectedFile.split('.').pop().toLowerCase();
            return officeExts.includes(ext);
        },
        
        async loadFiles() {
            try {
                const response = await fetch('/aview/files');
                if (response.ok) {
                    const json_data = await response.json();
                    if (json_data.success !== true) {
                        console.error('파일 목록 로드 실패: 응답이 성공적이지 않음', json_data);
                        return;
                    }
                    fileList = json_data.files || [];
                    console.log('로드된 파일 목록:', fileList);
                    this.files = fileList.map(fileInfo => ({
                        name: fileInfo.name || fileInfo,  // fileInfo가 객체면 name 속성, 문자열이면 그대로
                        size: fileInfo.size || 0,
                        modified: fileInfo.modified || 0,
                        checked: false
                    })); // 서버에서 이미 수정시간순으로 정렬됨
                }
            } catch (error) {
                console.error('파일 목록 로드 실패:', error);
            }
        },
        
        formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        },
        
        updateSelectedFiles() {
            const checkedFiles = this.files.filter(file => file.checked);
            if (checkedFiles.length === 1) {
                this.selectedFile = checkedFiles[0].name;
                this.updateUrl();
            } else {
                this.selectedFile = null;
                this.generatedUrl = '';
            }
        },
        
        updateUrl() {
            if (!this.selectedFile) {
                this.generatedUrl = '';
                return;
            }
            
            const baseUrl = `http://${appSettings.HOST}:${appSettings.PORT}`;
            const endpoint = this.mode;
            
            let params = [];
            
            if (this.inputType === 'path') {
                // 화면 표시용 - 인코딩 없이 보기 좋게
                params.push(`path=${appSettings.FILES_DIR}/${this.selectedFile}`);
            } else {
                // 화면 표시용 - 인코딩 없이 보기 좋게
                params.push(`url=${baseUrl}/aview/files/${this.selectedFile}`);
            }
            
            if (endpoint === 'convert') {
                params.push(`output=${this.output}`);
            }
            
            // 화면 표시용 URL (인코딩 안함)
            this.generatedUrl = `${baseUrl}/${endpoint}?${params.join('&')}`;
        },
        
        async uploadFiles(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            
            const formData = new FormData();
            for (let file of files) {
                formData.append('files', file);
            }
            
            try {
                const response = await fetch('/aview/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    await this.loadFiles();
                    event.target.value = ''; // 파일 입력 초기화
                } else {
                    alert('파일 업로드에 실패했습니다.');
                }
            } catch (error) {
                console.error('업로드 실패:', error);
                alert('파일 업로드에 실패했습니다.');
            }
        },
        
        async deleteSelected() {
            const selectedFiles = this.files.filter(file => file.checked);
            if (selectedFiles.length === 0) return;
            
            if (!confirm(`선택된 ${selectedFiles.length}개 파일을 삭제하시겠습니까?`)) return;
            
            try {
                // 각 파일을 개별적으로 삭제
                for (const file of selectedFiles) {
                    const response = await fetch(`/aview/delete?filename=${encodeURIComponent(file.name)}`, {
                        method: 'POST'
                    });
                    
                    if (!response.ok) {
                        alert(`파일 삭제에 실패했습니다: ${file.name}`);
                        return;
                    }
                }
                
                await this.loadFiles();
                this.selectedFile = null;
                this.generatedUrl = '';
            } catch (error) {
                console.error('삭제 실패:', error);
                alert('파일 삭제에 실패했습니다.');
            }
        },
        
        async deleteAll() {
            if (this.files.length === 0) return;
            
            if (!confirm('모든 파일을 삭제하시겠습니까?')) return;
            
            try {
                const response = await fetch('/aview/delete-all', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    this.files = [];
                    this.selectedFile = null;
                    this.generatedUrl = '';
                } else {
                    alert('파일 삭제에 실패했습니다.');
                }
            } catch (error) {
                console.error('전체 삭제 실패:', error);
                alert('파일 삭제에 실패했습니다.');
            }
        },
        
        runConversion() {
            if (!this.selectedFile) return;
            
            // 실제 실행용 URL 생성 (URL 인코딩 적용)
            const baseUrl = `http://${appSettings.HOST}:${appSettings.PORT}`;
            const endpoint = this.mode;
            
            let params = [];
            
            if (this.inputType === 'path') {
                // 실제 실행 시 - 파일명과 경로 인코딩
                params.push(`path=${encodeURIComponent(appSettings.FILES_DIR + '/' + this.selectedFile)}`);
            } else {
                // 실제 실행 시 - 전체 URL 인코딩
                const fileUrl = `${baseUrl}/aview/files/${encodeURIComponent(this.selectedFile)}`;
                params.push(`url=${encodeURIComponent(fileUrl)}`);
            }
            
            if (endpoint === 'convert') {
                params.push(`output=${this.output}`);
            }
            
            // 실제 실행용 URL (완전히 인코딩됨)
            const executionUrl = `${baseUrl}/${endpoint}?${params.join('&')}`;
            
            console.log('실행 URL:', executionUrl);
            window.open(executionUrl, '_blank');
        }
    };
}

// Alpine.js 초기화
document.addEventListener('alpine:init', () => {
    Alpine.data('testData', testComponent);
});
</script>
</body>
</html>
